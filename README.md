# 📚 Zotero 自动化标签整理工具 (Zotero Auto-Tagger)

update_tags_from_csv.py是一个基于 Python 的 Zotero 自动化脚本，旨在通过读取本地 CSV 表格文件，批量、精准地为 Zotero 云端文献库打上结构化的“正交标签”。

## ✨ 核心特性

* 🏷️ **智能解析与匹配**：自动提取 CSV 中的标题与标签，忽略大小写与首尾空格，与 Zotero 云端文献精准匹配。兼容 `['@标签1', '#标签2']` 列表格式及 `@标签1, #标签2` 逗号分隔格式。
* 🧹 **无损清理替换**：**自动过滤并删除原文献中所有以 `#` 开头的旧标签**（有效清理冗余的提取标签），同时**完美保留**你的私人标记（如 `已读`、`Q1` 等不带 `#` 的独立标签）。
* 🚀 **极强网络稳定性**：针对国内连接 Zotero 官方 API 容易超时的问题，引入了 **分批提交机制 (Batch)** 与 **3 次超时自动重试机制 (Retry)**，确保大批量更新时稳如泰山。
* ⚡ **按需更新**：自动对比新旧标签，只有当标签确实发生变化时才向服务器发起网络请求，极大地节省了运行时间并避免浪费 API 额度。

---

## 🛠️ 环境准备

### 1. 安装依赖库
在运行脚本之前，请确保你的电脑上安装了 Python（建议 Python 3.7+）。打开终端（CMD / Terminal）运行以下命令安装必要的依赖库：
`pip install pandas pyzotero`

### 2. 获取 Zotero API 凭证
本脚本直接与 Zotero 云端通信，因此需要你的授权凭证：
1. 登录 Zotero 网页版，进入安全设置页面：[Zotero Security Settings](https://www.zotero.org/settings/security)。

2. 记录页面中显示的纯数字 **`userID`**（这将填入脚本的 `LIBRARY_ID`）。
3. 点击 **Create new key** 创建新密钥。
4. **⚠️ 极其重要：** 必须勾选 **Allow write access (允许写入)** 权限。
5. 保存并复制生成的那串长字符（这将填入脚本的 `API_KEY`）。

---

## 📄 数据准备 (tags.csv)

在脚本同级目录下，必须放置一个名为 `tags.csv` 的文件。
该表格**必须包含以下两列**（列名严格区分大小写）：

| Title | Tags |
| :--- | :--- |
| Massive MIMO for Multi-LEO Satellite Positioning | `@大规模MIMO, @低轨卫星, #定位` |
| Efficient Base Station Handover via Multipoint... | `['#基站切换', '&机器学习/深度学习']` |
| Fluid Antenna-Assisted MIMO Transmission... | `@流体天线, #波束赋形, #Method` |

> **提示：** 标题不必完全一字不差（推荐尽量完整），脚本会自动转小写并去除首尾空格进行智能匹配。

---

## 🚀 使用指南

### 步骤 1：本地同步（运行前）
打开你电脑上的 Zotero 客户端，点击右上角的**绿色同步按钮**，等待转圈结束。确保你本地最新的文献都已上传到云端（脚本是去云端寻找文献的，如果本地未同步，脚本将提示“未找到匹配文献”）。

### 步骤 2：运行脚本
将配置好 API 的 Python 文件与 `tags.csv` 放在同一目录下，执行脚本：
`python update_tags.py`

*此时你会在控制台看到如下爽快的输出：*
```text
✅ 更新成功: 《Massive MIMO for Multi-LEO...》
   清理前: ['#旧标签1', '已读', 'Massive MIMO']
   更新后: ['@大规模MIMO', '已读', 'Massive MIMO', '#定位']
...
🚀 准备将 50 篇文献的新状态同步至 Zotero...
   -> ✅ 已成功同步第 1 到 20 篇。
```

### 步骤 3：拉取更新（运行后）

回到 Zotero 客户端，**再次点击右上角的绿色同步按钮**。

> **⚠️ 冲突解决指南：**
> 如果此时 Zotero 弹出了“冲突解决 (Conflict Resolution)”窗口询问你保留哪个版本，**请一律选择右侧的【远程/云端版本 (Remote Object)】**！因为我们的脚本是直接修改云端数据的，保留云端版本才能让新标签完美覆盖本地的旧标签。

完成同步后，你就会看到左下角的标签栏变得前所未有的干净与整齐！

---

## 📝 参数说明

如果你需要修改配置，可以直接在 Python 脚本开头的设置区域及第 5 步中更改以下变量：

* `API_KEY`：你在 Zotero 网页端生成的 API 密钥（**必须包含读写权限**）。
* `LIBRARY_ID`：你的 Zotero User ID（纯数字）。如果是操作群组文库，这里填 Group ID。
* `LIBRARY_TYPE`：
  * 操作你自己的个人文库，请填写 `'user'`。
  * 操作团队/共享的群组文库，请填写 `'group'`。
* `batch_size`：每次打包上传的文献数量。如果网络环境较差容易发生超时报错，可适当调小此数值（脚本默认为 `20`）。
* `max_retries`：当单个批次遭遇网络波动或超时报错时的自动重试次数（脚本默认为 `3`）。
